<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>Chromatic aberration Vis</title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css"></style>
    </head>
    <body>
<div class="body">
<div class="content">
<div class="pane" id="pane-1"> </div>
</body>
    <script type='text/javascript'>
      
    var opticalAxis = 300;
    
    var lensPower = 1/150;
    
    
    
    var deltaGreen = 0;
    var deltaRed = 0.26;
    var deltaBlue= -0.76;
    
    var lensRadius = 5.5 * 10; 
    var nRed = 1.33110,
    nGreen = 1.33639,
    nBlue = 1.33861;
    
    
    function getS(){
        var imagePosX = parseFloat(d3.select("#image").attr("x"));
        return -(imagePosX - getLensPosX()); 
    }
    
    function setS(s){
        d3.select("#image")
        .attr("x", getLensPosX() + s)
        .attr("transform", function(d,i){
                return "translate(" + [ s + getLensPosX() ,
                d.y ] + ")"
            });
    }
    
    function getSPrime(){
        var focusPosX = parseFloat(d3.select("#focus").attr("x"));
        return focusPosX - getLensPosX(); 
    }
    
    function setSPrimeGreen(sPrime){
        d3.select("#focusGreen").attr("x", getLensPosX() + sPrime)
        .attr("transform", function(d,i){
                return "translate(" + [ sPrime + getLensPosX() ,
                d.y ] + ")"
            });
    }
        function setSPrimeRed(sPrime){
        d3.select("#focusRed").attr("x", getLensPosX() + sPrime)
        .attr("transform", function(d,i){
                return "translate(" + [ sPrime + getLensPosX() ,
                d.y ] + ")"
            });
    }
        function setSPrimeBlue(sPrime){
        d3.select("#focusBlue").attr("x", getLensPosX() + sPrime)
        .attr("transform", function(d,i){
                return "translate(" + [ sPrime + getLensPosX() ,
                d.y ] + ")"
            });
    }
    
    function getLensPosX(){
        return parseFloat(d3.select("#lens").attr("cx"));
    }
    
    function getLensPower(r,n){
        return (n-1.0)/r;
    }
    
    
    function getLensPowerRed(){
        return getLensPower(lensRadius, nRed)
    }
    
    function getLensPowerGreen(){
        return getLensPower(lensRadius, nGreen)
    }
    
     function getLensPowerBlue(){
        return getLensPower(lensRadius, nBlue)
    }
    
    function updateFocusPlanes(){
    
        var newSPrimeRed = Math.round( 1/(getLensPowerRed()-(1/getS())));            
                var newSPrimeGreen = Math.round( 1/(getLensPowerGreen()-(1/getS())));
                var newSPrimeBlue = Math.round( 1/(getLensPowerBlue()-(1/getS())));
                
                console.log("s: " + getS());
                console.log("s'red: " + newSPrimeRed);
                console.log("s'green: " + newSPrimeGreen);
                console.log("s'blue: " + newSPrimeBlue);
                
                setSPrimeRed(newSPrimeRed);
                setSPrimeGreen(newSPrimeGreen);
                setSPrimeBlue(newSPrimeBlue);
    }
    
    var dragImage = d3.behavior.drag()
        .on("drag", function(d,i) {
            d.x += d3.event.dx;
            d3.select(this).attr("transform", function(d,i){
                return "translate(" + [ d.x,d.y ] + ")"
            })
            .attr("x", d.x);
            
            updateFocusPlanes()
            
        });

        
    var svg = d3.select("body")
        .append("svg:svg")
		.attr("width", "100%")
		.attr("height", "100%")
		.attr("id", "charts")

                      
    var lens = svg.append("ellipse")
        .attr("id", "lens")
        .attr("cx", 800)
        .attr("cy", opticalAxis)
        .attr("rx", 10)
        .attr("ry", 200)
        .attr("fill", "#555599");
         
    //optical axis
    svg.append("line")
        .attr("x1", 0)
        .attr("y1", opticalAxis)
        .attr("x2", 99999)
        .attr("y2", opticalAxis)
        .attr("stroke-width", 2)
        .attr("stroke", "#CCCCCC")
        .style("stroke-dasharray", ("3, 3"));
                  
    // focal points
    svg.append("line")
        .attr("x1", getLensPosX()+ 1/getLensPowerRed())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()+ 1/getLensPowerRed())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#FF0000")
        .style("stroke-dasharray", ("3, 3"));
        
    svg.append("line")
        .attr("x1",  getLensPosX()-1/getLensPowerRed())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()-1/getLensPowerRed())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#FF0000")
        .style("stroke-dasharray", ("3, 3"));
    
    svg.append("line")
        .attr("x1", getLensPosX()+ 1/getLensPowerGreen())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()+ 1/getLensPowerGreen())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#00FF00")
        .style("stroke-dasharray", ("3, 3"));
        
    svg.append("line")
        .attr("x1",  getLensPosX()-1/getLensPowerGreen())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()-1/getLensPowerGreen())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#00FF00")
        .style("stroke-dasharray", ("3, 3"));
        
    svg.append("line")
        .attr("x1", getLensPosX()+ 1/getLensPowerBlue())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()+ 1/getLensPowerBlue())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#0000FF")
        .style("stroke-dasharray", ("3, 3"));
        
    svg.append("line")
        .attr("x1",  getLensPosX()-1/getLensPowerBlue())
        .attr("y1", opticalAxis - 100)
        .attr("x2",  getLensPosX()-1/getLensPowerBlue())
        .attr("y2", opticalAxis + 100)
        .attr("stroke-width", 2)
        .attr("stroke", "#0000FF")
        .style("stroke-dasharray", ("3, 3"));
   
   
	//focus planes
   var focus_red = svg.append("svg:circle")
		.attr("id", "focusRed")
		.attr("transform", "translate(" + "10" + "," + opticalAxis + ")")
		.attr("fill", "#FF0000")
		.attr("fill-opacity", .8)
		.attr("stroke", "#000")
		.attr("stroke-width", 0)
		.attr("r", 12)
		.data([ {"x":10, "y":opticalAxis} ])
		.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return opticalAxis; });
    
	var focus_green = svg.append("svg:circle")
		.attr("id", "focusGreen")
		.attr("transform", "translate(" + "10" + "," + opticalAxis + ")")
		.attr("fill", "#00FF00")
		.attr("fill-opacity", .8)
		.attr("stroke", "#000")
		.attr("stroke-width", 0)
		.attr("r", 12)
		.data([ {"x":10, "y":opticalAxis} ])
		.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return opticalAxis; });
    
	var focus_blue = svg.append("svg:circle")
		.attr("id", "focusBlue")
		.attr("transform", "translate(" + "10" + "," + opticalAxis + ")")
		.attr("fill", "#0000FF")
		.attr("fill-opacity", .8)
		.attr("stroke", "#000")
		.attr("stroke-width", 0)
		.attr("r", 12)
		.data([ {"x":10, "y":opticalAxis} ])
		.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return opticalAxis; });
   
    //image plane
	var image = svg.append("svg:g")
		.attr("id", "image")
		.attr("transform", "translate(" + "10" + "," + opticalAxis + ")")
		.data([ {"x":10, "y":opticalAxis} ])
		.attr("x", function(d) { return d.x; })
		.attr("y", function(d) { return opticalAxis; })
		.call(dragImage);
    
	image.append("line")
		.attr("x1", 0)
		.attr("y1", 999)
		.attr("x2", 0)
		.attr("y2", -999)
		.attr("stroke-width", 5)
		.attr("stroke", "black");
    
</script>
</html>
